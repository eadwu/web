<!DOCTYPE HTML>
<!--
	KIDNAPPED BY ALIENS!!!!!!

	The code below outlines a simple program about a party of explorers who have been kidnapped by aliens.  Trapped in the alien tunnels, the explorers are trying to dig their way through 100 meters of alien terrain in order to escape.  Unfortuanately, the aliens keep coming and taking one of them away!  Each round, the explorers must plan to fight in case the aliens come or plan to dig in the hopes that they do not.  If they plan to fight, they have a greater chance of beating back the aliens if they come.  If they plan to dig, they have a better chance of digging further if the aliens do not come.

	Familiarize yourself with the code below.  Ask questions if you have them.  Once you are comfortable with the code, choose and work on one of the activities listed.

	/****************************************************************************/

	ACTIVITES - DO NOT READ UNTIL YOU HAVE FAMILIARIZED YOURSELF WITH THE CODE

	Items:	There is a 5% chance that the party will find some items when they are digging.
			If an item is found, it will automatically be assigned to a random character of the correct type.  A character may only hold one item.  If there are no spaces for the item, it is thrown away.
			Adjust the output so that the player can see which items are held by which explorers.

		Power Shovel (Digger) - a power shovel will dig an extra 1-3 * the digger's skill per turn.
		Ray Gun (Fighter) - a ray gun will add 1-3 * the fighter's skill to the explorers's total during a fight.
		Head Lamp (Planner) - a head lamp will add 1 - 6 to the digging or fighting total when the planner comes into play.

	/***************************************************************************/

	Aliens:	Create different types of aliens, just like there are different types of explorers.
			This means that there is no random number of aliens attacking.  It is always the same party of aliens.  Use the same formula for determining the number of aliens in an attack to determine the number of aliens in the party.
			You'll need to update the display to show what aliens are in the alien party.

		Overlord - There is a 10% chance that there is an overlord in the alien party.  There can only be one overlord.  If there is an overlord, the base probability that the aliens will attack is increased by .1.
		Warriors - There is a 25% chance that a warrior will be added to the party each time an alien is created.  When determining the alienSkill during an attack, count the warriors twice.
		Drone - Every alien that is not an Overlord or a warrior is a drone.  Drones have no special powers.

		Because there are specific aliens now, they can die, too.  If the explorers should best the aliens during an attack, remove 1 alien.  The drones will die first, then the warriors, and finally the overlord (if there is one).

	/***************************************************************************/

	Events:	Every round, there os a 5% chance of some extra event occurring in the tunnels.

	Cave In - Part of the tunnel collapses, increasing the number of meters remaining by betweeen 1 and 10 meters (note that there can never be more than TUNNEL_METERS meters remaining).
	Cave Spider - A giant spider comes hunting.  If there is an alien attack, the spider will drive them off and retreat (it kills one if you've completed the Aliens activity because aliens are tastier than humans).  Otherwise, it will take an explorer.
	Survivor - Someone thought lost from the expedition shows up and helps.  Use the same probabilities that are used at the beginning of program to deternine whether the survivor is a digger, dighter, or a planner.
	Hollow Space (only if digging has taken place) - The diggers have cut through to an empty space in the tunnel,  decreasing the number of meters remaining by 1 and 10.
-->
<html>
<head>
  <title>Kidnapped By Aliens!!!!!!</title>

  <link rel="stylesheet" href="https://www.dropbox.com/s/73ithjlt7zfxn0o/columns.css?raw=1" />
  <link rel="stylesheet" href="https://www.dropbox.com/s/hncvhcgnlp6g8jq/dressing.css?raw=1" />

  <style>
    body {
      color: white;
    }

    .column {
      border: thick double cornflowerblue;
      border-radius: 20px;
      position: relative;
    }

    .colcontent {
      font: 18pt comic sans ms;

    }

    .bgrnd {
      opacity: 0.45;
    }

    .titlecontent {
      font: 36pt arial;
      font-weight: bold;
      border: 10px double cornflowerblue;
      border-radius: 20px;
    }

    .columncontainer {
      margin-top: 75px;
    }

    button {
      font: 18pt arial;
      background-color: cornflowerblue;
    }
  </style>

  <script src="utilities.js"></script>
  <script>

    function nOfVInX(v, x)
    {
      return x.reduce(function (a, cV)
      {
        return cV === v ? a + 1 : a;
      }, 0);
    }

    function addCharacter(character, skillLevel)
    {
      characters.push(character);
      skills.push(skillLevel);
    }

    function deleteCharacter(cIdx)
    {
      characters.splice(cIdx, 1);
      skills.splice(cIdx, 1);
      items.splice(cIdx, 1);
    }

    function caveIn()
    {
      var adjuster = getRandomInteger(1, 10);
      var adjustedMetersRemaining = metersRemaining + adjuster;

      roundMessage = "A cave in has occured, digging regressed by " + adjuster + " m! ";
      metersRemaining = adjustedMetersRemaining >= TUNNEL_METERS ? TUNNEL_METERS : adjustedMetersRemaining;
    }

    function caveSpider()
    {
      // Possible target for cleanup
      roundMessage = "A cave spider has appeared, ";
      if (aliens.length > 0)
      {
        var chosenAlienIdx = getRandomInteger(0, aliens.length - 1);
        var chosenAlienType = ALIEN_NAMES[ aliens[ chosenAlienIdx ] - 3 ];

        roundMessage += "One of the aliens, a(n) " + chosenAlienType + " has been eaten by the spider! ";
        aliens.splice(getRandomInteger(0, aliens.length - 1), 1);
      }
      else
      {
        var chosenCharacterIdx = getRandomInteger(0, characters.length - 1);
        var chosenCharacterType = CHARACTER_NAMES[ characters[ chosenCharacterIdx ] ];

        roundMessage += "One of your party members, a(n) " + chosenCharacterType + " has been eaten by the spider! ";
        deleteCharacter(chosenCharacterIdx, 1);
      }
    }

    function survivor()
    {
      var rand = Math.random();
      var chosenCharacter = rand < PLANNER_CHANCE ? PLANNER
        : rand < FIGHTER_CHANCE ? FIGHTER
          : DIGGER;
      var chosenCharacterName = CHARACTER_NAMES[ chosenCharacter ];

      roundMessage = "A survivor was found, the " + chosenCharacterName + " has joined your party! ";
      addCharacter(chosenCharacter, getRandomInteger(1, 3));
    }

    function hollowSpace()
    {
      var adjustedMetersRemaining = getRandomInteger(1, 10);

      roundMessage = "The diggers have found an empty space, digging progressed by " + adjustedMetersRemaining + " m! ";
      metersRemaining -= adjustedMetersRemaining;
    }

    function initialize()
    {
      IN_PROGRESS = 0, ESCAPED = 1, DESTROYED = 2;
      DIGGER_CHANCE = 1, FIGHTER_CHANCE = 0.6, PLANNER_CHANCE = 0.2;
      DRONE_CHANCE = 1, WARRIOR_CHANCE = 0.25, OVERLORD_CHANCE = 0.1;
      ITEM_CHANCE = 10; // TODO: Revert back to 0.05 -> 5% chance
      EVENT_CHANCE = 0.05;

      CHARACTER_NAMES = [ "Digger", "Fighter", "Planner" ];
      ALIEN_NAMES = [ "Drone", "Warrior", "Overlord" ];
      ITEM_NAMES = [ "Power Shovel", "Ray Gun", "Head Lamp" ];
      EVENTS = [ caveIn, caveSpider, survivor, hollowSpace ];

      OVERLORD_BASE_INCREMENT = 0.1;
      DIGGER = 0, FIGHTER = 1, PLANNER = 2;
      DRONE = 3, WARRIOR = 4, OVERLORD = 5;
      POWER_SHOVEL = 6, RAY_GUN = 7, HEAD_LAMP = 8;

      DIG = 0, FIGHT = 1;
      TUNNEL_METERS = 100;
      ALIENS = 0.6, ALIEN_PARTY = 6;
      DIFFERENTIAL = 2;

      aliens = [];
      characters = [];
      skills = [];
      items = [];
      roundChoice = DIG;
      aliensComing = ALIENS;
      gameState = IN_PROGRESS;
      roundMessage = "";

      metersRemaining = TUNNEL_METERS;

      messageOut = document.getElementById("round");
      rosterOut = document.getElementById("party");
      alienRosterOut = document.getElementById("alien_party");
      metersOut = document.getElementById("distance");

      buildCharacters(getRandomInteger(6, 10), getRandomInteger(6, 10));
      display();
    }

    function buildCharacters(howManyNoobs, howManyAliens)
    {
      // for (var i = 0; i < howMany; i++)
      // {
      //   characters.push(getRandomInteger(DIGGER, PLANNER));
      //   skills.push(getRandomInteger(1, 3));
      // }

      forNDo(howManyNoobs, function ()
      {
        addCharacter(getRandomInteger(DIGGER, PLANNER), getRandomInteger(1, 3));
      });

      forNDo(howManyAliens, function ()
      {
        var rand = Math.random();
        var chosenAlien = aliens.indexOf(OVERLORD) > -1 ? rand <= WARRIOR_CHANCE ? WARRIOR
          : DRONE
          // yeahh about the constant...
          : rand <= OVERLORD_CHANCE ? (ALIENS += OVERLORD_BASE_INCREMENT, aliensComing = ALIENS, OVERLORD)
            : rand <= WARRIOR_CHANCE ? WARRIOR
              : DRONE;

        aliens.push(chosenAlien);
      });
    }

    function aliensAttack()
    {
      // if (Math.random() > aliensComing)
      if (Math.random() > aliensComing || aliens.length <= 0)
      {
        aliensComing += 0.1;
        if (aliensComing > ALIENS)
          aliensComing = ALIENS;

        return 0;
      }
      else
      {
        // var numAliens = ALIEN_PARTY + getRandomInteger(0, aliensComing * 10);
        var numAliens = aliens.length;
        aliensComing -= 0.1;
        return numAliens;
      }
    }

    function getCharacterSkill(cType)
    {
      // skill = 0;
      // for (var i = 0; i < characters.length; i++)
      // {
      // if (characters[ i ] == cType)
      // skill += skills[ i ];
      // }
      //
      // return skill;
      return characters.reduce(function (a, v, i)
      {
        return v === cType ? a + skills[ i ] : a;
      }, 0);
    }

    function runAttack(numAliens)
    {
      var fighterSkill = getCharacterSkill(FIGHTER);

      if (roundChoice === FIGHT)
      {
        fighterSkill += getCharacterSkill(PLANNER) + items.reduce(function (a, cV, i)
        {
          return cV === RAY_GUN ? a + getRandomInteger(1, 3) * skills[ i ]
            : cV === HEAD_LAMP ? a + getRandomInteger(1, 6)
              : a;
        }, 0);
      }
      else
      {
        fighterSkill /= DIFFERENTIAL;
      }

      // var alienSkill = numAliens + getRandomInteger(0, ALIEN_PARTY);
      var alienSkill = aliens.reduce(function (a, v)
      {
        return v === WARRIOR ? a + 2 : a + 1;
      }, 0);
      if (alienSkill > fighterSkill)
      {
        // var deadCharacterIdx = getRandomInteger(0, characters.length - 1);
        // characters.splice(deadCharacterIdx, 1);
        // skills.splice(deadCharacterIdx, 1);
        deleteCharacter(getRandomInteger(0, characters.length - 1));
        // return "You were overwhelmed by " + numAliens + " of them and lost a character";
        return "You were overwhelmed by " + numAliens + " of them and lost a character.";
      }

      // Expand to if statement since there is no assignment
      aliens.indexOf(DRONE) > -1 ? aliens.splice(aliens.indexOf(DRONE), 1)
        : aliens.indexOf(WARRIOR) > -1 ? aliens.splice(aliens.indexOf(WARRIOR), 1)
          : aliens = [];
      return "You beat back " + numAliens + " aliens!";
    }

    function runDig()
    {
      var diggerSkill = getCharacterSkill(DIGGER);

      if (roundChoice === DIG)
      {
        diggerSkill += getCharacterSkill(PLANNER) + items.reduce(function (a, cV, i)
        {
          return cV === POWER_SHOVEL ? a + getRandomInteger(1, 3) * skills[ i ]
            : cV === HEAD_LAMP ? a + getRandomInteger(1, 6)
              : a
        }, 0);
      }
      else
      {
        diggerSkill /= DIFFERENTIAL;
      }

      diggerSkill = Math.round(diggerSkill);
      if (diggerSkill <= 1)
        diggerSkill = 1;

      metersRemaining -= diggerSkill;
      return diggerSkill;
    }

    function runRound(plan)
    {
      if (gameState !== IN_PROGRESS)
        return;

      roundChoice = plan;
      numAliens = aliensAttack();

      if (Math.random() <= EVENT_CHANCE)
        EVENTS[ getRandomInteger(0, EVENTS.length - 1) ]();

      if (numAliens > 0)
      {
        // roundMessage = "The aliens are attacking!";
        roundMessage += "The aliens are attacking!";
        roundMessage += "  " + runAttack(numAliens);
      }
      else
      {
        if (Math.random() <= ITEM_CHANCE)
        {
          var chosenItemIndex = getRandomInteger(POWER_SHOVEL, HEAD_LAMP);
          var adjustedChosenItemIndex = chosenItemIndex - 6;

          var chosenItemName = ITEM_NAMES[ adjustedChosenItemIndex ];
          var formattedItemName = chosenItemName.toLowerCase();
          var validCharacterType = CHARACTER_NAMES[ adjustedChosenItemIndex ];

          var numberOfValidCharacters = nOfVInX(adjustedChosenItemIndex, characters);
          var numberOfValidItemsOwned = nOfVInX(chosenItemIndex, items);

          roundMessage += "A " + formattedItemName + " was found! ";
          if (numberOfValidCharacters === numberOfValidItemsOwned)
          {
            roundMessage += "The item has been discarded due to an insufficient amount of " + validCharacterType + "s. ";
          }
          else
          {
            var dividerIdx = items.indexOf(chosenItemIndex);
            var adjustedDividerIdx = dividerIdx < 0 ? 0 : dividerIdx + 1;
            var targetIdx = characters.slice(adjustedDividerIdx).indexOf(adjustedChosenItemIndex) + adjustedDividerIdx;

            items[ targetIdx ] = chosenItemIndex;
          }
        }

        // roundMessage = "You dug through " + runDig() + " meters.";
        roundMessage += "You dug through " + runDig() + " meters.";
      }

      checkGameOver();

      display();
      // Possible target for improvement, don't hard code solution
      roundMessage = "";
    }

    function checkGameOver()
    {
      if (characters.length === 0)
        gameState = DESTROYED;

      if (metersRemaining <= 0)
        gameState = ESCAPED;
    }

    function display()
    {
      rosterOut.innerHTML = "";
      alienRosterOut.innerHTML = "";

      // for (var i = 0; i < characters.length; i++)
      // rosterOut.innerHTML += CHARACTER_NAMES[ characters[ i ] ] + " (" + skills[ i ] + ")<br />";
      rosterOut.innerHTML = characters.map(function (_, i)
      {
        return CHARACTER_NAMES[ characters[ i ] ] + " (" + skills[ i ] + ")" + (items[ i ] ? " [" + ITEM_NAMES[ items[ i ] - 6 ] + "]" : "");
      }).join("<br />");

      alienRosterOut.innerHTML = aliens.map(function (_, i)
      {
        return ALIEN_NAMES[ aliens[ i ] - 3 ];
      }).join("<br />");

      metersOut.innerHTML = metersRemaining;
      messageOut.innerHTML = roundMessage + "<br />";

      if (gameState === DESTROYED)
        messageOut.innerHTML += "You were destroyed!";

      if (gameState === ESCAPED)
        messageOut.innerHTML += "You made it to freedom!";
    }

  </script>
</head>

<body onload="initialize();">
  <img class="bgrnd" src="https://www.dropbox.com/s/edduwzez1fbs46s/alien%20tunnels.png?raw=1" />
  <h1 class="titlecontainer">
    <span class="titlecontent">Kidnapped By Aliens!!!!!!</span>
  </h1>
  <div class="columncontainer">
    <div class="column">
      <img class="bgrnd" src="https://www.dropbox.com/s/d5xjwzxj4o03aud/alien%20walls.jpg?raw=1" />
      <div class="contentbox">
        <h1 class="coltitle">Your Party</h1>
        <div class="colcontent" id="party"></div>
      </div>
    </div>
    <div class="column">
      <img class="bgrnd" src="https://www.dropbox.com/s/d5xjwzxj4o03aud/alien%20walls.jpg?raw=1" />
      <div class="contentbox">
        <h1 class="coltitle">Control Board</h1>
        <button onclick="runRound(DIG);">Plan to Dig</button>
        <button onclick="runRound(FIGHT);">Plan to Fight</button>
        <hr />
        <div class="colcontent">
          <span id="distance">100</span> meters remaining.</div>
        <hr />
        <div class="colcontent" id="round"></div>
      </div>
    </div>
    <div class="column">
      <img class="bgrnd" src="https://www.dropbox.com/s/d5xjwzxj4o03aud/alien%20walls.jpg?raw=1" />
      <div class="contentbox">
        <h1 class="coltitle">Alien Party</h1>
        <div class="colcontent" id="alien_party"></div>
      </div>
    </div>
</body>
</html>
